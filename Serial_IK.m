clear all
clc
syms q1 q2 q3 q4 q5;
s1=sin(q1);
s2=sin(q2);
s3=sin(q3);
s4=sin(q4);
s5=sin(q5);
c1=cos(q1);
c2=cos(q2);
c3=cos(q3);
c4=cos(q4);
c5=cos(q5);
T01=[c1,-s1,0,0;
    s1,c1,0,0;
    0,0,1,63;
    0,0,0,1];
T12=[c2,-s2,0,0;
    0,0,-1,0;
    s2,c2,0,0;
    0,0,0,1];
T23=[c3,-s3,0,153;
    s3,c3,0,0;
    0,0,1,0;
    0,0,0,1];
T34=[c4,-s4,0,153;
    s4,c4,0,0;
    0,0,1,0;
    0,0,0,1];
T45=[c5,-s5,0,0;
    0,0,-1,-68;
    s5,c5,0,0;
    0,0,0,1];
T56=[1,0,0,0;
    0,1,0,0;
    0,0,1,30;
    0,0,0,1];
T06=T01*T12*T23*T34*T45*T56;
l1=153;
l2=153;
h=63;

syms r11 r12 r13 r21 r22 r23 r31 r32 r33 px py pz;
t06=[r11,r12,r13,px
    r21,r22,r23,py;
    r31,r32,r33,pz;
    0,0,0,1];

x6=t06(1,4);
y6=t06(2,4);
z6=t06(3,4);
q11=atan2(y6,x6);
q12=atan2(y6,x6)+pi; %%Q1= -90 < (q11 or q12)*180/pi < 90

t16=inv(T01)*t06;
T16=T12*T23*T34*T45*T56;
a1=t16(2,4);
T26=T23*T34*T45*T56;
t26=inv(T12)*t16;
T36=T34*T45*T56;
t36=inv(T23)*t26;
t05=t06*inv(T56);
T05=T01*T12*T23*T34*T45;
t04=t05*inv(T45);
T04=T01*T12*T23*T34;

x4=t04(1,4);
y4=t04(2,4);
z4=t04(3,4);
r4=sqrt((x4)^2+(y4)^2);
c31=-((r4)^2+(z4-h)^2-l1^2-l2^2)/(2*l1*l2);
q31=atan2(sqrt(1-(c31)^2),-c31);
q32=atan2(-sqrt(1-(c31)^2),-c31); %%Q3= -170 < (q31 or q32)*180/pi <0

a=(z4-h)/(sqrt((x4)^2+(y4)^2));
b1=(l2*sin(q31))/(l1+l2*cos(q31));
b2=(l2*sin(q32))/(l1+l2*cos(q32));%%q31 or q32
theta1=atan(a);
theta2=pi-theta1;
alpha1=atan(b1);
alpha2=atan(b2);
q21=theta1-alpha1;
q22=theta2-alpha1;
q23=theta1-alpha2;
q24=theta2-alpha2; %% Q2= 0< (q21 or q22 or q23 or q24)*180/pi < 150

syms Q1 Q2 Q3;
s1=sin(Q1);
s2=sin(Q2);
s3=sin(Q3);
c1=cos(Q1);
c2=cos(Q2);
c3=cos(Q3);
T01=[c1,-s1,0,0;
    s1,c1,0,0;
    0,0,1,63;
    0,0,0,1];
T12=[c2,-s2,0,0;
    0,0,-1,0;
    s2,c2,0,0;
    0,0,0,1];
T23=[c3,-s3,0,153;
    s3,c3,0,0;
    0,0,1,0;
    0,0,0,1];
T03=T01*T12*T23;
t03=t04*inv(T34);
R03=[T03(1,1:3);T03(2,1:3);T03(3,1:3)];
R06=[t06(1,1:3);t06(2,1:3);t06(3,1:3)];
R36=inv(R03)*R06;
q4=atan2(R36(1,3),-R36(2,3)); 
q5=atan2(R36(3,1),R36(3,2)); %% Euler angles